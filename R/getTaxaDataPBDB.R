#' Obtaining Data for Sets of Taxa From Paleobiology Database API
#' 
#' The Paleobiology Database API (\href{http://paleobiodb.org/data1.2}{link}) is very easy to use, and generally any data one wishes to collect

#' @details
#' The



#' @param taxon A single name of a of a higher taxon which you wish to catch
#' all taxonomic 'children' (included members - i.e. subtaxa) of, from 
#' within the Paleobiology Database.

#' @param taxa A character vector listing taxa of interest that the user
#' wishes to download information on from the Paleobiology Database.
#' Multiple taxa can be listed as a single character string, with desired taxa
#' separated by a comma with no whitespace (ex.
#' \code{"Homo,Pongo,Gorilla"}) or as a vector of character strings
#' (ex. \code{c("Homo", "Pongo", "Gorilla")}),
#' which will then formatted for use in the API call.
	
#' @param show Which variables should be requested from the Paleobiology
#' Database? The default is to include classification (\code{"class"}),
#' parent-child taxon information (\code{"parent"}), information on each
#' taxon's first and last appearance (\code{"app"}), information on the
#' PhyloPic silhouette images assigned to that taxon (\code{"img"}), and
#' the names of those who entered and authorized the taxonomic data you
#' have downloaded (\code{"entname"}). Multiple variable blocks can be
#' given as a single character string, with desired variable selections
#' separated by a comma with no whitespace (ex. \code{"class,img,app"}) or 
#' as a vector of character strings (ex. \code{c("class", "img", "app")}),
#' which will then formatted for use in the API call. Other options that
#' you might want to include, such as information on ecospace or taphonomy,
#' can be included: please refer to the full list at
#' the \href{http://paleobiodb.org/data1.2/taxa/list_doc.htm}{documentation for the API}.

	
#' @param status What taxonomic status should the pull taxa have? 
#' The default is \code{status = "accepted"}, which means 
#' only those taxa that are both valid taxa and 
#' \emph{the accepted senior homonym}. Other typical statuses
#' to consider are \code{"valid"}, which is all valid taxa:
#' senior homonyms and valid subjective synonyms, and \code{"all"},
#' which will return all valid taxa and all otherwise repressed invalid taxa.
#' For additional statuses that you can request, please see the documentation at  
#' the \href{http://paleobiodb.org/data1.2/taxa/list_doc.htm}{documentation for the API}.
	
	# status -> all, accepted, valid
	# accepted -> only senior synonyms
	# valid -> snior synonyms + valid subjective synonyms
	# all -> valid taxa + repressed invalid taxa

#' @param urlOnly If \code{FALSE} (the default), then the
#' function behaves as expected, the API is called and a
#' data table pulled from the Paleobiology Database is returned.
#' If \code{urlOnly = TRUE}, the URL of the API call is returned
#' instead as a character string. 

#' @param stopIfMissing If some taxa within the requested set appear
#' to be missing from the Paleobiology Database's taxonomy table, should
#' the function halt with an error?

#' @return 
#' These functions return a \code{data.frame} containing
#' variables pulled for the requested taxon selection.
#' This behavior can be modified by argument \code{urlOnly}.

#' @name getTaxaDataPBDB

#' @aliases getCladeTaxaPBDB getSpecificTaxaPBDB

#' @seealso 
#' See \code{\link{getTaxaDataPBDB}}, \code{\link{makePBDBtaxonTree}},
#' and \code{\link{plotPhylopicTreePBDB}}.


#' @author David W. Bapst

#' @references
#' Peters, S. E., and M. McClennen. 2015. The Paleobiology Database
#' application programming interface. \emph{Paleobiology} 42(1):1-7.


#' @examples
#' 
#' #an example here




#' @rdname getTaxaDataPBDB 
#' @export 
getCladeTaxaPBDB <- function(taxon,
		show = c("class", "parent", "app", "img", "entname"),
		status = "accepted", urlOnly = FALSE, stopIfMissing=FALSE){
	##########################################
	# check that only a single taxon is given
	if(length(taxon) != 1){
		stop("taxon should only be a single name of a higher taxon which you wish to catch all children of")
		}
	###################################
	# 12-30-18: modified for API version 1.2
	#let's get some taxonomic data
	requestURLPBDB <- paste0("http://paleobiodb.org/",
			"data1.2/taxa/list.txt?base_name=", taxon,
			"&show=",paste0(show,collapse = ","),
			# status -> all, accepted, valid
				# accepted -> only senior synonyms
				# valid -> snior synonyms + valid subjective synonyms
				# all -> valid taxa + repressed invalid taxa
			"&taxon_status=",status
			)
	if(urlOnly){
		res <- requestURLPBDB
	}else{
		res <- getPBDBtaxaCSV(requestURLPBDB, stopIfMissing=stopIfMissing)
		}
	#######################################
	return(res)
	}

#' @rdname getTaxaDataPBDB 
#' @export 
getSpecificTaxaPBDB <- function(taxa,
		show = c("class", "parent", "app", "img", "entname"),
		status = "accepted",
		urlOnly = FALSE, stopIfMissing=FALSE){
	#####################################
	if(length(taxa)>1){
		# collapse taxa to a vector
		taxa <- paste0(taxa,
			collapse=",")		
		}
	requestURLPBDB <- paste0(
		"http://paleobiodb.org/data1.2/taxa/list.txt?name=",taxa,
		"&show=",paste0(show,collapse = ","),
		# status -> all, accepted, valid
			# accepted -> only senior synonyms
			# valid -> snior synonyms + valid subjective synonyms
			# all -> valid taxa + repressed invalid taxa
		"&taxon_status=",status
		)
	if(urlOnly){
		res <- requestURLPBDB
		# browseURL(apiAddressTaxa)
	}else{
		res <- getPBDBtaxaCSV(requestURLPBDB, stopIfMissing=stopIfMissing)
		}
	##################################
	# return
	return(res)
	}	

getPBDBtaxaCSV <- function(requestURL, stopIfMissing=FALSE){
	linesOut <- readLines(requestURL)
	if(any(linesOut == "\"Records:\"")){
		# then there must be errors, report them
		isWarning <- startsWith(linesOut, 
			prefix = "\"Warning:\",")
		for(i in which(isWarning)){
			errorMsg <- linesOut[i]
			errorMsg <- gsub("\"Warning:\",\"",
				"", errorMsg)
			warning(errorMsg)
			}
		if(stopIfMissing){
			stop(paste0(
				"Some taxa not found in PBDB taxonomy table,",
				" see warnings and check API request URL: \n",
				requestURL
				))
			}
		lineRemove <- c(which(isWarning),which(linesOut == "\"Records:\""))
		linesOut<-linesOut[-lineRemove]
		}
	res<- read.csv(text = linesOut,
	    stringsAsFactors = FALSE)
	###############
	return(res)
	}	

